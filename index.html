<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚´ãƒ¼ãƒ«ãƒœãƒ¼ãƒ«ã‚µãƒ¼ãƒã‚²ãƒ¼ãƒ </title>
    <!-- Tailwind CSS CDN (ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã¨çµ±ä¸€æ„Ÿã®ãŸã‚ã«ä½¿ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 100vh;
            padding: 1rem;
            color: #1f2937;
        }

        #mainGame {
            width: 100%;
            max-width: 500px;
            padding: 1.5rem;
            background: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .top {
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.75rem;
        }

        #kgbalogo {
            border-radius: 0.5rem;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1d4ed8;
        }

        .question-display {
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .result-area {
            text-align: center;
        }

        .input-display {
            font-size: 3rem;
            font-weight: 900;
            color: #ef4444;
            min-height: 3.5rem;
        }

        .message {
            min-height: 1.5rem;
            font-weight: 500;
            color: #10b981; /* Default success color */
        }

        #keypadWrap {
            padding: 1rem 0;
            background: #f1f5f9;
            border-radius: 0.75rem;
        }

        #keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr) 1.5fr; /* 4åˆ—ç›®ã‚’ã€Œç¢º å®šã€ãƒœã‚¿ãƒ³ç”¨ã«è¿½åŠ  */
            gap: 0.5rem;
            padding: 0 1rem;
        }

        .key, .confirm, #startBtn, #retryBtn, #nameSubmitBtn, footer button {
            padding: 0.75rem 0.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.1s ease-in-out;
            box-shadow: 0 3px #6b7280;
            background-color: #e5e7eb;
            color: #1f2937;
            border: none;
        }

        .key:active, .confirm:active, #startBtn:active, #retryBtn:active, #nameSubmitBtn:active, footer button:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        .confirm {
            grid-column: 4 / 5; /* 4åˆ—ç›®ã«é…ç½® */
            grid-row: 1 / 5; /* 1è¡Œç›®ã‹ã‚‰4è¡Œç›®ã¾ã§ã‚’å æœ‰ */
            background-color: #22c55e;
            color: white;
            box-shadow: 0 3px #15803d;
        }
        .confirm:active {
            box-shadow: none;
            background-color: #16a34a;
        }
        
        .clear {
            background-color: #fca5a5;
            box-shadow: 0 3px #ef4444;
        }
        .clear:active {
            box-shadow: none;
            background-color: #f87171;
        }

        .accent, #startBtn, #retryBtn {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 3px #2563eb;
        }
        .accent:active, #startBtn:active, #retryBtn:active {
            box-shadow: none;
            background-color: #1d4ed8;
        }

        .control-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }
        .control-container button {
            width: 100%;
        }

        footer {
            width: 100%;
            max-width: 500px;
            margin-top: 1rem;
            padding: 1rem;
            background: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .controls button {
            flex-grow: 1;
            font-size: 0.875rem;
            padding: 0.5rem;
            box-shadow: 0 2px #9ca3af;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .ranking-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .ranking-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        #rankingList, .rule-content-area {
            margin-top: 1rem;
            font-size: 1rem;
            line-height: 1.6;
        }
        
        #rankingList div {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        #rankingList div:last-child {
            border-bottom: none;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rank-score {
            font-weight: bold;
            color: #ef4444;
        }

        #closeRankingBtn, #closeRuleBtn {
            margin-top: 1.5rem;
            background-color: #9ca3af;
            color: white;
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

        .name-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        #nameInput {
            flex-grow: 1;
            padding: 0.5rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
        }
        #scoreDisplay {
            margin-top: 1rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: #1d4ed8;
            text-align: center;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .rule-tip {
            font-size: 0.9rem;
            color: #4b5563;
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>

<main id="mainGame" role="main">
    <header class="top">
        <!-- ãƒ­ã‚´ç”»åƒã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼URLã‚’ä½¿ç”¨ -->
        <a href="https://goalball-kanagawa.org/" target="_blank" rel="noopener noreferrer">
            <!-- ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒ: 50x50ã®é’ã„å††ã€ãƒ†ã‚­ã‚¹ãƒˆã€ŒKGBAã€ -->
            <img id="kgbalogo" src="https://placehold.co/50x50/0077b6/ffffff?text=KGBA" alt="KGBAãƒ­ã‚´" />
        </a>
        <h1>ã‚´ãƒ¼ãƒ«ãƒœãƒ¼ãƒ«ã‚µãƒ¼ãƒã‚²ãƒ¼ãƒ </h1>
    </header>

    <!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="currentQ" class="question-display" aria-live="polite">ã‚¤ãƒ¤ãƒ›ãƒ³ã‚’è£…ç€ã—ã€ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ã­ï¼</div>

    <!-- å›ç­”å…¥åŠ›ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <section id="resultArea" class="result-area" role="status" aria-label="å›ç­”å…¥åŠ›ã‚¨ãƒªã‚¢">
        <div id="inputDisplay" class="input-display" aria-live="polite">0.0</div>
        <div id="message" class="message" aria-live="polite"></div>
    </section>

    <!-- ãƒ†ãƒ³ã‚­ãƒ¼ã‚¨ãƒªã‚¢ (ã‚²ãƒ¼ãƒ ä¸­ã¯è¡¨ç¤º) -->
    <section id="keypadWrap" role="application" aria-label="ãƒ†ãƒ³ã‚­ãƒ¼" style="display:none;" aria-hidden="true">
        <div id="keypad">
            <!-- ãƒ†ãƒ³ã‚­ãƒ¼ã®ãƒœã‚¿ãƒ³ (HTMLã¯å…ƒã®é€šã‚Š) -->
            <button class="key" data-key="7" type="button">7</button>
            <button class="key" data-key="8" type="button">8</button>
            <button class="key" data-key="9" type="button">9</button>
            
            <button class="key" data-key="4" type="button">4</button>
            <button class="key" data-key="5" type="button">5</button>
            <button class="key" data-key="6" type="button">6</button>

            <button class="key" data-key="1" type="button">1</button>
            <button class="key" data-key="2" type="button">2</button>
            <button class="key" data-key="3" type="button">3</button>

            <button class="key clear" data-key="C" type="button">C</button>
            <button class="key" data-key="0" type="button">0</button>
            <button class="key" data-key="." type="button">.</button>

            <!-- ç¢ºå®šãƒœã‚¿ãƒ³ -->
            <button class="confirm" data-key="ENTER" type="button">ç¢º å®š</button>
        </div>
    </section>
    
    <!-- åå‰å…¥åŠ›ã‚¨ãƒªã‚¢ (ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«è¡¨ç¤º) -->
    <section id="nameInputWrap" class="name-input-area" style="display:none;" aria-hidden="true" role="form" aria-labelledby="name-input-title">
        <h2 id="name-input-title" class="text-xl font-bold text-center">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²</h2>
        <p class="name-prompt text-center mt-2">ã‚²ãƒ¼ãƒ çµ‚äº†ã§ã™ï¼ã‚¹ã‚³ã‚¢ã‚’ç™»éŒ²ã—ã¾ã—ã‚‡ã†ã€‚</p>
        <div id="scoreDisplay" aria-live="polite" class="text-2xl font-extrabold text-red-600 my-4 text-center"></div> 
        <div class="name-form">
            <input type="text" id="nameInput" placeholder="ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ10æ–‡å­—ã¾ã§ï¼‰" maxlength="10" aria-label="ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²ç”¨ãŠåå‰å…¥åŠ›æ¬„">
            <button id="nameSubmitBtn" class="accent" type="button" aria-label="åå‰ã‚’ç™»éŒ²ã™ã‚‹">ç™» éŒ²</button>
        </div>
    </section>

    <!-- ã‚²ãƒ¼ãƒ çµ‚äº†å¾Œã®å†æŒ‘æˆ¦ãƒœã‚¿ãƒ³ (åå‰ç™»éŒ²å¾Œã«è¡¨ç¤º) -->
    <section id="retryWrap" class="control-container" style="display:none;" aria-hidden="true" role="region" aria-label="å†æŒ‘æˆ¦">
        <button id="retryBtn" class="accent" aria-label="å†æŒ‘æˆ¦" type="button">å†æŒ‘æˆ¦</button>
    </section>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ (ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®ã¿è¡¨ç¤º) -->
    <div class="control-container" id="startBtnContainer">
        <button id="startBtn" class="accent" aria-label="ã‚²ãƒ¼ãƒ é–‹å§‹" type="button">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

</main>

<!-- ç”»é¢ä¸‹éƒ¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
<footer role="contentinfo">
    <section class="controls control-row-1" aria-label="æƒ…å ±ç¢ºèª" role="region">
        <button id="ruleBtn" type="button">ãƒ«ãƒ¼ãƒ«</button>
        <button id="checkBtn" type="button">ã‚¤ãƒ¤ãƒ›ãƒ³ç¢ºèª</button>
        <button id="rankingBtn" type="button">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </section>

    <section class="controls control-row-2" aria-label="ãƒ’ãƒ³ãƒˆ" role="region">
        <button id="hintLBtn" type="button">ãƒ’ãƒ³ãƒˆL</button>
        <button id="hintRBtn" type="button">ãƒ’ãƒ³ãƒˆR</button>
    </section>
</footer>


<!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<section id="rankingWrap" class="ranking-modal" style="display:none;" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="ranking-title">
    <div class="ranking-content">
        <h2 id="ranking-title" class="text-2xl font-bold text-center mb-4">ğŸ† ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <div id="rankingList">
            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            <p class="text-center text-gray-500" id="loadingRanking">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        <button id="closeRankingBtn" type="button" class="mt-4">é–‰ã˜ã‚‹</button>
    </div>
</section>

<!-- ãƒ«ãƒ¼ãƒ«è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<section id="ruleWrap" class="ranking-modal" style="display:none;" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="rule-title">
    <div class="ranking-content">
        <h2 id="rule-title" class="text-2xl font-bold text-center mb-4">ğŸ§ ãƒ«ãƒ¼ãƒ«èª¬æ˜</h2>
        <div id="ruleContent" class="rule-content-area text-left">
            <p>ã“ã®ã‚²ãƒ¼ãƒ ã¯ã€éŸ³ã‚’é ¼ã‚Šã«ãƒœãƒ¼ãƒ«ã®ä½ç½®ã‚’äºˆæ¸¬ã—ã€ãã®ä½ç½®ã‚’æ•°å­—ï¼ˆ0.0ï½9.9ï¼‰ã§è§£ç­”ã™ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚å…¨10å•ã§ã™ã€‚</p>
            <ol class="list-decimal list-inside space-y-2 mt-4">
                <li>**ã‚¹ã‚¿ãƒ¼ãƒˆ**ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã‚Šã¾ã™ã€‚</li>
                <li>å·¦å³ã®è€³ã‹ã‚‰èã“ãˆã‚‹**ãƒœãƒ¼ãƒ«ã®éŸ³**ï¼ˆéŸ³é‡ã‚„å®šä½ï¼‰ã‚’é ¼ã‚Šã«ã€ãƒœãƒ¼ãƒ«ãŒã‚³ãƒ¼ãƒˆä¸Šã®ã©ã“ã«ã‚ã‚‹ã‹ã‚’äºˆæ¸¬ã—ã¾ã™ã€‚</li>
                <li>ã‚³ãƒ¼ãƒˆã¯å·¦ç«¯ãŒ**0.0**ã€å³ç«¯ãŒ**10.0**ã¨ãªã£ã¦ãŠã‚Šã€**0.0ã‹ã‚‰9.9ã¾ã§**ã®ç¯„å›²ã§å°æ•°ç‚¹ç¬¬ä¸€ä½ã¾ã§å…¥åŠ›ã—ã¾ã™ã€‚</li>
                <li>ãƒ†ãƒ³ã‚­ãƒ¼ã§æ•°å€¤ã‚’å…¥åŠ›ã—ã€**ç¢º å®š**ãƒœã‚¿ãƒ³ã§è§£ç­”ã—ã¾ã™ã€‚</li>
                <li>**ãƒ’ãƒ³ãƒˆL** / **ãƒ’ãƒ³ãƒˆR** ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®å•é¡Œã®éŸ³ã‚’æ¥µç«¯ã«å·¦/å³ã«æŒ¯ã£ãŸçŠ¶æ…‹ã§å†ç”Ÿã—ã€æ‰‹ãŒã‹ã‚Šã‚’å¾—ã‚‰ã‚Œã¾ã™ã€‚</li>
                <li>æ­£è§£ã¨ã®èª¤å·®ãŒå°ã•ã„ã»ã©é«˜ã‚¹ã‚³ã‚¢ã«ãªã‚Šã¾ã™ã€‚</li>
            </ol>
            <p class="rule-tip">â€» æ­£ç¢ºãªéŸ³å£°ã§ã®ä½“é¨“ã®ãŸã‚ã€ã‚¤ãƒ¤ãƒ›ãƒ³ã¾ãŸã¯ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³ã®ç€ç”¨ãŒå¿…é ˆã§ã™ã€‚</p>
        </div>
        <button id="closeRuleBtn" type="button" class="mt-4">é–‰ã˜ã‚‹</button>
    </div>
</section>

<div id="a11yStatus" class="sr-only" aria-live="assertive"></div>

<script type="module">
    // Firebaseã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firestoreã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š (ãƒ‡ãƒãƒƒã‚°ç”¨)
    // setLogLevel('debug');

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (Canvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // FirebaseåˆæœŸåŒ–
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;

    // Web Audio APIé–¢é€£
    let audioContext;
    let panner;
    let gainNode;

    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
    const GAME_QUESTIONS = 10;
    let gameState = 'initial'; // 'initial', 'playing', 'finished'
    let currentQuestion = 0;
    let currentTargetPosition = 0; // 0.0 to 9.9
    let currentInput = "0.0";
    let totalScore = 0;

    // DOMè¦ç´ 
    const dom = {
        startBtn: document.getElementById('startBtn'),
        retryBtn: document.getElementById('retryBtn'),
        keypadWrap: document.getElementById('keypadWrap'),
        nameInputWrap: document.getElementById('nameInputWrap'),
        nameInput: document.getElementById('nameInput'),
        nameSubmitBtn: document.getElementById('nameSubmitBtn'),
        retryWrap: document.getElementById('retryWrap'),
        startBtnContainer: document.getElementById('startBtnContainer'),
        currentQ: document.getElementById('currentQ'),
        inputDisplay: document.getElementById('inputDisplay'),
        message: document.getElementById('message'),
        scoreDisplay: document.getElementById('scoreDisplay'),
        rankingWrap: document.getElementById('rankingWrap'),
        ruleWrap: document.getElementById('ruleWrap'),
        rankingList: document.getElementById('rankingList'),
        ruleBtn: document.getElementById('ruleBtn'),
        checkBtn: document.getElementById('checkBtn'),
        rankingBtn: document.getElementById('rankingBtn'),
        hintLBtn: document.getElementById('hintLBtn'),
        hintRBtn: document.getElementById('hintRBtn'),
        closeRankingBtn: document.getElementById('closeRankingBtn'),
        closeRuleBtn: document.getElementById('closeRuleBtn'),
        a11yStatus: document.getElementById('a11yStatus')
    };

    /**
     * ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®ãŸã‚ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿ä¸Šã’ã•ã›ã‚‹
     * @param {string} msg èª­ã¿ä¸Šã’ã•ã›ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    function announce(msg) {
        dom.a11yStatus.textContent = msg;
    }

    // --- Firebase/Firestoreé–¢é€£ ---

    /**
     * Firebaseèªè¨¼ã¨Firestoreã®åˆæœŸåŒ–
     */
    async function initializeFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // èªè¨¼å‡¦ç†
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase initialized and signed in. User ID:", userId);
                    // èªè¨¼å®Œäº†å¾Œã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã‚€
                    loadRanking(); 
                } else {
                    // åŒ¿åèªè¨¼ãŒå¤±æ•—ã—ãŸå ´åˆ
                    userId = crypto.randomUUID();
                    isAuthReady = true;
                    console.error("Authentication failed. Using random UUID:", userId);
                    loadRanking();
                }
            });

        } catch (error) {
            console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ã‚²ãƒ¼ãƒ è‡ªä½“ã¯å‹•ãã‚ˆã†ã«ã™ã‚‹ (ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã¯ä¸å¯)
            isAuthReady = true;
        }
    }

    /**
     * ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’Firestoreã«ä¿å­˜
     * @param {string} name ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å
     * @param {number} score ã‚¹ã‚³ã‚¢ (å¹³å‡èª¤å·®)
     */
    async function saveRanking(name, score) {
        if (!isAuthReady || !db) {
            console.error("FirestoreãŒæœªåˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            dom.message.textContent = "ã‚¨ãƒ©ãƒ¼: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            return;
        }

        try {
            // ãƒ‘ã‚¹: /artifacts/{appId}/public/data/goalball_ranking
            const rankingRef = collection(db, `artifacts/${appId}/public/data/goalball_ranking`);
            
            await addDoc(rankingRef, {
                userId: userId,
                name: name.trim() || "åç„¡ã—",
                score: score, // ã‚¹ã‚³ã‚¢ã¯ä½ã„ã»ã©è‰¯ã„
                timestamp: Date.now()
            });

            dom.message.textContent = `${name}ã•ã‚“ã®ã‚¹ã‚³ã‚¢ ${score.toFixed(3)} ã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã—ã¾ã—ãŸï¼`;
            announce("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ã‚¹ã‚³ã‚¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚");
            loadRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å†èª­ã¿è¾¼ã¿
        } catch (error) {
            console.error("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
            dom.message.textContent = "ã‚¨ãƒ©ãƒ¼: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            announce("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
    }

    /**
     * ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿ã€è¡¨ç¤ºã‚’æ›´æ–°
     */
    async function loadRanking() {
        if (!isAuthReady || !db) return;
        
        dom.rankingList.innerHTML = '<p class="text-center text-gray-500">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';

        try {
            const rankingRef = collection(db, `artifacts/${appId}/public/data/goalball_ranking`);
            
            // ã‚¹ã‚³ã‚¢ãŒä½ã„é † (èª¤å·®ãŒå°ã•ã„é †) ã«ã‚½ãƒ¼ãƒˆ
            const q = query(rankingRef, orderBy('score', 'asc')); // 'asc' (æ˜‡é †) ã§èª¤å·®ãŒå°ã•ã„é †
            const querySnapshot = await getDocs(q);

            let rankingHtml = '<div class="space-y-2">';
            let rank = 1;
            
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä¸Šä½10ä»¶ã®ã¿ã‚’æŠ½å‡º
            const topScores = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                              .sort((a, b) => a.score - b.score) // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚‚ä½ã„é †ã«ã‚½ãƒ¼ãƒˆ
                                              .slice(0, 10);


            if (topScores.length === 0) {
                rankingHtml += '<p class="text-center text-gray-500">ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
                topScores.forEach(data => {
                    // ã‚¹ã‚³ã‚¢ã‚’å°æ•°ç‚¹ä»¥ä¸‹3æ¡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    const formattedScore = data.score.toFixed(3);
                    const isUser = data.userId === userId ? 'bg-yellow-100 font-extrabold' : '';
                    rankingHtml += `
                        <div class="rank-item p-2 rounded-lg ${isUser}">
                            <span>${rank}. ${data.name}</span>
                            <span class="rank-score">${formattedScore}</span>
                        </div>
                    `;
                    rank++;
                });
            }

            rankingHtml += '</div>';
            dom.rankingList.innerHTML = rankingHtml;

        } catch (error) {
            console.error("ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            dom.rankingList.innerHTML = '<p class="text-center text-red-500">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>';
        }
    }


    // --- Web Audio API/ç«‹ä½“éŸ³éŸ¿é–¢é€£ ---

    /**
     * Web Audio APIã‚’åˆæœŸåŒ–
     */
    function initAudioContext() {
        // Safariãªã©ã§å¿…è¦ã«ãªã‚‹Webkitãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚‚è€ƒæ…®
        if (audioContext) return;
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // ã‚¹ãƒ†ãƒ¬ã‚ªãƒ‘ãƒ³ãƒŠãƒ¼ãƒãƒ¼ãƒ‰ã‚’ä½œæˆ
        panner = audioContext.createStereoPanner();
        panner.connect(audioContext.destination);

        // ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã‚’ä½œæˆ (éŸ³é‡èª¿æ•´ç”¨)
        gainNode = audioContext.createGain();
        gainNode.connect(panner);
    }

    /**
     * ãƒœãƒ¼ãƒ«ã®éŸ³ã‚’å†ç”Ÿ
     * @param {number} position 0.0 (å·¦) ã‹ã‚‰ 10.0 (å³) ã¾ã§ã®ã‚³ãƒ¼ãƒˆä¸Šã®ä½ç½®
     * @param {number} duration éŸ³ã®å†ç”Ÿæ™‚é–“ (ç§’)
     * @param {number} panOverride -1.0(å·¦) ã‹ã‚‰ 1.0(å³) ã¾ã§ã®ãƒ‘ãƒ³ã®å¼·åˆ¶å€¤ (ãƒ’ãƒ³ãƒˆç”¨)
     */
    function playBallSound(position, duration = 1.0, panOverride = null) {
        initAudioContext();
        if (audioContext.state === 'suspended') {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ã‚ˆã‚‹AudioContextã®å†é–‹
            audioContext.resume().catch(e => console.error("AudioContext resume failed:", e));
        }

        // 0.0 - 10.0 ã®ä½ç½®ã‚’ -1.0 - 1.0 ã®ãƒ‘ãƒ³å€¤ã«ãƒãƒƒãƒ”ãƒ³ã‚°
        // 0.0 -> -1.0 (å·¦ç«¯)
        // 5.0 -> 0.0 (ä¸­å¤®)
        // 10.0 -> 1.0 (å³ç«¯)
        // ä½ç½®ã¯0.0ï½9.9ãªã®ã§ã€10.0ã‚’æœ€å¤§å€¤ã¨ã™ã‚‹
        const panValue = panOverride !== null ? panOverride : (position / 5.0) - 1.0;

        const now = audioContext.currentTime;
        
        // ä¸€æ™‚çš„ã«ã‚¹ãƒ†ãƒ¬ã‚ªãƒ‘ãƒ³ã‚’è¨­å®š
        panner.pan.setValueAtTime(panValue, now);

        // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚µã‚¤ãƒ³æ³¢ã§ãƒœãƒ¼ãƒ«ã®éŸ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        const newOscillator = audioContext.createOscillator();
        newOscillator.type = 'sine';
        // ã‚´ãƒ¼ãƒ«ãƒœãƒ¼ãƒ«ã®éŸ³ã‚’æ¨¡ã™ãŸã‚ã€å‘¨æ³¢æ•°ã¯å°‘ã—ä½ã‚ã«è¨­å®šï¼ˆéˆ´ã®éŸ³ã‚’æ¨¡å€£ï¼‰
        newOscillator.frequency.setValueAtTime(250, now);

        // éŸ³ã®é³´å‹•ï¼ˆéŸ³é‡ãŒå¾ã€…ã«ä¸‹ãŒã‚‹ï¼‰
        gainNode.gain.setValueAtTime(0.3, now); // åˆæœŸéŸ³é‡
        gainNode.gain.exponentialRampToValueAtTime(0.0001, now + duration); // æ¸›è¡°

        newOscillator.connect(gainNode);
        newOscillator.start(now);
        newOscillator.stop(now + duration);
    }

    /**
     * ã‚¤ãƒ¤ãƒ›ãƒ³å·¦å³ç¢ºèªç”¨ã®éŸ³ã‚’å†ç”Ÿ
     */
    function playCheckSound() {
        initAudioContext();
        if (audioContext.state === 'suspended') {
            audioContext.resume().catch(e => console.error("AudioContext resume failed:", e));
        }

        const now = audioContext.currentTime;

        // å·¦è€³ã§ã€Œå·¦ã€ã®éŸ³ã‚’å†ç”Ÿ
        panner.pan.setValueAtTime(-1.0, now);
        const oscL = audioContext.createOscillator();
        oscL.frequency.setValueAtTime(600, now);
        oscL.connect(gainNode);
        gainNode.gain.setValueAtTime(0.5, now);
        gainNode.gain.linearRampToValueAtTime(0.0001, now + 0.5);
        oscL.start(now);
        oscL.stop(now + 0.5);

        // 0.7ç§’å¾Œã«å³è€³ã§ã€Œå³ã€ã®éŸ³ã‚’å†ç”Ÿ
        setTimeout(() => {
            const nextTime = audioContext.currentTime;
            panner.pan.setValueAtTime(1.0, nextTime);
            const oscR = audioContext.createOscillator();
            oscR.frequency.setValueAtTime(600, nextTime);
            oscR.connect(gainNode);
            gainNode.gain.setValueAtTime(0.5, nextTime);
            gainNode.gain.linearRampToValueAtTime(0.0001, nextTime + 0.5);
            oscR.start(nextTime);
            oscR.stop(nextTime + 0.5);
            announce("å·¦ã€å³ã®éŸ³ãŒæµã‚Œã¾ã—ãŸã€‚");
        }, 700);
        
        dom.message.textContent = "å·¦ã€å³ã®éŸ³ã‚’å†ç”Ÿã—ã¾ã—ãŸã€‚";
    }


    // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

    /**
     * ã‚²ãƒ¼ãƒ ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
     */
    function resetGame() {
        gameState = 'initial';
        currentQuestion = 0;
        totalScore = 0;
        currentInput = "0.0";
        dom.inputDisplay.textContent = currentInput;
        dom.message.textContent = "";
        dom.currentQ.textContent = "ã‚¤ãƒ¤ãƒ›ãƒ³ã‚’è£…ç€ã—ã€ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ã­ï¼";
        dom.startBtnContainer.style.display = 'flex';
        dom.keypadWrap.style.display = 'none';
        dom.nameInputWrap.style.display = 'none';
        dom.retryWrap.style.display = 'none';
    }

    /**
     * æ–°ã—ã„å•é¡Œã‚’è¨­å®š
     */
    function generateNewQuestion() {
        if (currentQuestion >= GAME_QUESTIONS) {
            endGame();
            return;
        }

        currentQuestion++;
        // 0.0ã‹ã‚‰9.9ã¾ã§ã®ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ï¼ˆå°æ•°ç‚¹ç¬¬ä¸€ä½ã¾ã§ï¼‰
        currentTargetPosition = Math.floor(Math.random() * 100) / 10; 
        currentInput = "0.0";
        dom.inputDisplay.textContent = currentInput;
        dom.message.textContent = "éŸ³å£°ã‚’å†ç”Ÿã—ã¾ã™...";
        
        dom.currentQ.textContent = `ç¬¬${currentQuestion}å•ç›® (${GAME_QUESTIONS}å•ä¸­)ã€‚ãƒœãƒ¼ãƒ«ã®ä½ç½®ã‚’äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚`;
        announce(`ç¬¬${currentQuestion}å•ç›®ã§ã™ã€‚ãƒœãƒ¼ãƒ«ã®ä½ç½®ã‚’äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚`);

        // å•é¡Œã®éŸ³ã‚’å†ç”Ÿ
        setTimeout(() => {
            playBallSound(currentTargetPosition, 1.0);
            dom.message.textContent = "å…¥åŠ›ã—ã¦ãã ã•ã„ (0.0 - 9.9)";
        }, 500);
    }

    /**
     * ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
     */
    function startGame() {
        if (gameState === 'playing') return;
        
        resetGame(); // å¿µã®ãŸã‚ãƒªã‚»ãƒƒãƒˆ
        gameState = 'playing';
        dom.startBtnContainer.style.display = 'none';
        dom.keypadWrap.style.display = 'block';
        
        dom.message.textContent = "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼";
        announce("ã‚²ãƒ¼ãƒ é–‹å§‹ï¼");
        generateNewQuestion();
    }

    /**
     * ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
     */
    function endGame() {
        gameState = 'finished';
        dom.keypadWrap.style.display = 'none';
        dom.nameInputWrap.style.display = 'block';
        
        // å¹³å‡èª¤å·®ã‚¹ã‚³ã‚¢ (ä½ã„ã»ã©è‰¯ã„)
        const finalScore = totalScore / GAME_QUESTIONS; 
        dom.currentQ.textContent = "å…¨å•çµ‚äº†ï¼";
        dom.scoreDisplay.textContent = `å¹³å‡èª¤å·®ã‚¹ã‚³ã‚¢: ${finalScore.toFixed(3)}`;
        dom.message.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        announce(`ã‚²ãƒ¼ãƒ çµ‚äº†ã§ã™ã€‚ã‚ãªãŸã®å¹³å‡èª¤å·®ã‚¹ã‚³ã‚¢ã¯${finalScore.toFixed(3)}ã§ã™ã€‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
    }

    /**
     * å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ¬¡ã®å•é¡Œã¸é€²ã‚€
     */
    function checkAnswer() {
        if (gameState !== 'playing') return;

        const answer = parseFloat(currentInput);
        if (isNaN(answer) || answer < 0 || answer >= 10) {
            dom.message.textContent = "ç„¡åŠ¹ãªå…¥åŠ›ã§ã™ (0.0ï½9.9)ã€‚";
            announce("ç„¡åŠ¹ãªå…¥åŠ›ã§ã™ã€‚0.0ã‹ã‚‰9.9ã¾ã§ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        // èª¤å·®ã‚’è¨ˆç®—
        const error = Math.abs(currentTargetPosition - answer);
        
        // totalScoreã«èª¤å·®ã‚’åŠ ç®— (ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯å¹³å‡èª¤å·®ã€ä½ã„ã»ã©è‰¯ã„)
        totalScore += error;

        let feedback;
        if (error < 0.1) {
            feedback = `ğŸŒŸ ç´ æ™´ã‚‰ã—ã„ï¼èª¤å·®${error.toFixed(2)}ã€‚`;
        } else if (error < 0.5) {
            feedback = `â— ãƒ‹ã‚¢ãƒŸã‚¹ï¼èª¤å·®${error.toFixed(2)}ã€‚`;
        } else if (error < 1.0) {
            feedback = `â–³ ã‚‚ã†å°‘ã—ï¼èª¤å·®${error.toFixed(2)}ã€‚`;
        } else {
            feedback = `Ã— å¤§ããªèª¤å·®ã§ã™ (${error.toFixed(2)})ã€‚`;
        }

        const actualPos = currentTargetPosition.toFixed(1);
        dom.message.textContent = `${feedback} æ­£è§£ã¯${actualPos}ã§ã—ãŸã€‚`;
        announce(`${feedback} æ­£è§£ã¯${actualPos}ã§ã—ãŸã€‚æ¬¡ã®å•é¡Œã¸é€²ã¿ã¾ã™ã€‚`);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç­”ãˆã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã€å°‘ã—é–“ã‚’ç©ºã‘ã¦ã‹ã‚‰æ¬¡ã¸
        setTimeout(() => {
            generateNewQuestion();
        }, 3000);
    }

    /**
     * ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
     * @param {string} key å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼
     */
    function handleKeyInput(key) {
        if (gameState !== 'playing') return;

        let tempInput = currentInput;

        if (key === 'C') {
            tempInput = "0";
        } else if (key === 'ENTER') {
            checkAnswer();
            return;
        } else if (key === '.') {
            if (!tempInput.includes('.')) {
                tempInput += '.';
            }
        } else {
            // æ•°å­—ã®å‡¦ç†
            if (tempInput === "0") {
                tempInput = key;
            } else if (tempInput.includes('.')) {
                // å°æ•°ç‚¹ä»¥ä¸‹ã¯1æ¡ã¾ã§
                const parts = tempInput.split('.');
                if (parts[1].length < 1) {
                    tempInput += key;
                }
            } else if (tempInput.length < 1) {
                // æ•´æ•°éƒ¨ã¯æœ€å¤§1æ¡ (0-9)
                tempInput += key;
            }
        }

        // 9.9ã‚’è¶…ãˆã‚‹å…¥åŠ›ã¯è¨±å¯ã—ãªã„
        if (parseFloat(tempInput) >= 10) {
            if (tempInput.includes('.') && tempInput.split('.')[0].length > 1) {
                 tempInput = "9.9";
            } else if (!tempInput.includes('.') && tempInput.length > 1) {
                tempInput = tempInput.charAt(0); // 2æ¡ç›®ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰æœ€åˆã®æ¡ã ã‘æ®‹ã™
            }
        }
        
        // è¡¨ç¤ºç”¨ã®æ•´å½¢
        if (tempInput === ".") {
            dom.inputDisplay.textContent = "0.";
            currentInput = "0.";
        } else if (tempInput.endsWith('.')) {
             dom.inputDisplay.textContent = tempInput;
             currentInput = tempInput;
        } else {
            const num = parseFloat(tempInput);
            // 0ã‹ã‚‰9.9ã®ç¯„å›²ã§ã€å°æ•°ç‚¹ä»¥ä¸‹1æ¡ã¾ã§è¡¨ç¤º
            dom.inputDisplay.textContent = num.toFixed(tempInput.includes('.') ? 1 : 0);
            currentInput = dom.inputDisplay.textContent; // æ­£å¼ãªå…¥åŠ›ã¨ã—ã¦ä¿å­˜
        }
    }
    
    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---

    function setupEventListeners() {
        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
        dom.startBtn.addEventListener('click', startGame);

        // å†æŒ‘æˆ¦ãƒœã‚¿ãƒ³
        dom.retryBtn.addEventListener('click', resetGame);

        // ãƒ†ãƒ³ã‚­ãƒ¼ãƒœã‚¿ãƒ³
        document.querySelectorAll('#keypad .key, #keypad .confirm').forEach(button => {
            button.addEventListener('click', (e) => {
                handleKeyInput(e.target.dataset.key);
            });
        });

        // åå‰ç™»éŒ²ãƒœã‚¿ãƒ³
        dom.nameSubmitBtn.addEventListener('click', () => {
            const name = dom.nameInput.value || "åç„¡ã—";
            const score = totalScore / GAME_QUESTIONS; // å¹³å‡èª¤å·®ã‚¹ã‚³ã‚¢
            dom.nameInputWrap.style.display = 'none';
            dom.retryWrap.style.display = 'flex';
            saveRanking(name, score);
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º/éè¡¨ç¤º
        dom.ruleBtn.addEventListener('click', () => { dom.ruleWrap.style.display = 'flex'; announce("ãƒ«ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸã€‚"); });
        dom.closeRuleBtn.addEventListener('click', () => { dom.ruleWrap.style.display = 'none'; });
        dom.rankingBtn.addEventListener('click', () => { 
            loadRanking();
            dom.rankingWrap.style.display = 'flex'; 
            announce("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸã€‚"); 
        });
        dom.closeRankingBtn.addEventListener('click', () => { dom.rankingWrap.style.display = 'none'; });
        
        // ã‚¤ãƒ¤ãƒ›ãƒ³ç¢ºèªãƒœã‚¿ãƒ³
        dom.checkBtn.addEventListener('click', playCheckSound);

        // ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³
        dom.hintLBtn.addEventListener('click', () => {
            if (gameState === 'playing') {
                playBallSound(currentTargetPosition, 1.0, -1.0); // å·¦ã«å›ºå®šã—ã¦å†ç”Ÿ
                dom.message.textContent = "ãƒ’ãƒ³ãƒˆL: éŸ³å£°ã‚’å·¦ã«å›ºå®šã—ã¦å†ç”Ÿã—ã¾ã—ãŸã€‚";
                announce("ãƒ’ãƒ³ãƒˆå·¦ã€‚éŸ³å£°ã‚’å·¦ã«å›ºå®šã—ã¦å†ç”Ÿã—ã¾ã—ãŸã€‚");
            }
        });
        dom.hintRBtn.addEventListener('click', () => {
            if (gameState === 'playing') {
                playBallSound(currentTargetPosition, 1.0, 1.0); // å³ã«å›ºå®šã—ã¦å†ç”Ÿ
                dom.message.textContent = "ãƒ’ãƒ³ãƒˆR: éŸ³å£°ã‚’å³ã«å›ºå®šã—ã¦å†ç”Ÿã—ã¾ã—ãŸã€‚";
                announce("ãƒ’ãƒ³ãƒˆå³ã€‚éŸ³å£°ã‚’å³ã«å›ºå®šã—ã¦å†ç”Ÿã—ã¾ã—ãŸã€‚");
            }
        });
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã®ã‚µãƒãƒ¼ãƒˆ (ãƒ†ãƒ³ã‚­ãƒ¼ã¨åŒã˜å‹•ä½œ)
        document.addEventListener('keydown', (e) => {
            const keyMap = {
                '0': '0', '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8', '9': '9',
                '.': '.', 'Delete': 'C', 'Backspace': 'C', 'Enter': 'ENTER'
            };
            if (keyMap[e.key]) {
                e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã‚’æŠ‘åˆ¶
                handleKeyInput(keyMap[e.key]);
                // å¯¾å¿œã™ã‚‹ãƒœã‚¿ãƒ³ã«è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¸ãˆã‚‹ (ä»»æ„)
                const btn = document.querySelector(`[data-key="${keyMap[e.key]}"]`);
                if (btn) {
                    btn.classList.add('scale-95', 'opacity-80');
                    setTimeout(() => btn.classList.remove('scale-95', 'opacity-80'), 100);
                }
            }
        });
    }

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
    window.onload = function () {
        initializeFirebase();
        initAudioContext(); // AudioContextã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã«å†é–‹ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚‹
        setupEventListeners();
        resetGame(); // åˆæœŸç”»é¢è¡¨ç¤º
    };

</script>

</body>
</html>