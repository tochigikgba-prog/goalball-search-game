/* script_v2.js */

const SOUND_PATH = "sound/";

// --- 音声ファイル一覧（名前はexact） ---
const QUIZ_FILES = {
  "0":"quiz_0.mp3", "1":"quiz_1.mp3", "2":"quiz_2.mp3", "3":"quiz_3.mp3", 
  "4":"quiz_4.mp3", "4.5":"quiz_45.mp3", "5":"quiz_5.mp3", "6":"quiz_6.mp3", 
  "7":"quiz_7.mp3", "8":"quiz_8.mp3", "9":"quiz_9.mp3"
};
const ANSWER_FILES = {
  "0":"answer_0.mp3","1":"answer_1.mp3","2":"answer_2.mp3","3":"answer_3.mp3",
  "4":"answer_4.mp3","4.5":"answer_45.mp3","5":"answer_5.mp3","6":"answer_6.mp3",
  "7":"answer_7.mp3","8":"answer_8.mp3","9":"answer_9.mp3"
};
const seikaiFile = "seikai.mp3";
const noFile = "no.mp3";
// 修正後
const ruleFiles = ["zunda_rule001.mp3", "zunda_rule002.mp3", "zunda_rule003.mp3", "zunda_rule004.mp3", "zunda_rule005.mp3"];
const hintSeqFiles = ["hint_01.mp3","hint.mp3"];
const hintBellFiles = ["hint.mp3"];
const checkFile = "zunda_check.mp3";
const enterSound = "enter.mp3";
const gameSuccessFile = "game_success.mp3"; 

// 入力数字の音声ファイルマップ
const INPUT_FILES = {
  "0": "input_0.mp3", "1": "input_1.mp3", "2": "input_2.mp3", "3": "input_3.mp3",
  "4": "input_4.mp3", "5": "input_5.mp3", "6": "input_6.mp3", "7": "input_7.mp3",
  "8": "input_8.mp3", "9": "input_9.mp3", ".": "input_dot.mp3",
  "C": "input_clear.mp3" 
};

// --- ランキング定数（Firebase用） ---
// GASのAPI_ENDPOINT_URLは削除されています
const RANKING_COLLECTION_NAME = 'ranking'; 

// --- UI要素 ---
const ruleBtn = document.getElementById("ruleBtn");
const checkBtn = document.getElementById("checkBtn");
const stopBtn = document.getElementById("stopBtn");
const hintBtn = document.getElementById("hintBtn");
const hintBellBtn = document.getElementById("hintBellBtn");
const startBtn = document.getElementById("startBtn");
const keypad = document.getElementById("keypad");
const keypadWrap = document.getElementById("keypadWrap");
const currentInput = document.getElementById("currentInput");
const questionLabel = document.getElementById("questionLabel");
const resultDiv = document.getElementById("result");
const retryWrap = document.getElementById("retryWrap");
const retryBtn = document.getElementById("retryBtn");
const scoreDisplay = document.getElementById("scoreDisplay");
const a11yStatus = document.getElementById("a11yStatus"); 

// ランキング関連のUI要素
const postGameControls = document.getElementById("postGameControls"); 
const rankingWrap = document.getElementById("rankingWrap");
const rankingList = document.getElementById("rankingList");
const closeRankingBtn = document.getElementById("closeRankingBtn"); 


let audioMap = {}; 
let currentAudio = null; 
let isPlaying = false; 
let playingButton = null;
let gameQueue = []; 
let questionIndex = 0;
let playerInput = ""; 
let score = 0;
let startTime = 0; // タイム計測用の変数
const TOTAL_QUESTIONS = 3;

// ----- I. 初期化とプリロード -----
function preload(filename){
  const path = SOUND_PATH + filename;
  const a = new Audio(path);
  a.preload = "auto";
  audioMap[filename] = a;
}

function preloadAll(){
  Object.values(QUIZ_FILES).forEach(preload);
  Object.values(ANSWER_FILES).forEach(preload);
  [seikaiFile,noFile,enterSound,checkFile,gameSuccessFile].forEach(f=>preload(f)); 
  ruleFiles.forEach(preload);
  hintSeqFiles.forEach(preload);
  hintBellFiles.forEach(preload);
  Object.values(INPUT_FILES).forEach(preload); 
}
preloadAll();

// ----- II. 再生ユーティリティ -----
function playAudioElement(filename, isInput = false, buttonElement = null){
  return new Promise((resolve, reject) => {
    if (!filename) { resolve(); return; }
    
    if (!isInput && isPlaying) {
        stopAll(); 
    } 
    
    let a;
    if (audioMap[filename]) {
      try { a = audioMap[filename].cloneNode(true); } catch (e) { a = new Audio(SOUND_PATH + filename); }
    } else {
      a = new Audio(SOUND_PATH + filename);
    }
    a.preload = "auto";
    
    try { a.pause(); a.currentTime = 0; } catch(e){}
    
    if (!isInput) {
        currentAudio = a;
        isPlaying = true;
        playingButton = buttonElement;
    }
    
    const onEnded = () => {
      a.removeEventListener("ended", onEnded);
      a.removeEventListener("error", onErr);
      if (currentAudio === a) {
          currentAudio = null;
          isPlaying = false;
          playingButton = null;
      }
      resolve();
    };
    const onErr = (ev) => {
      a.removeEventListener("error", onErr);
      a.removeEventListener("ended", onEnded);
      if (currentAudio === a) {
          currentAudio = null;
          isPlaying = false;
          playingButton = null;
      }
      console.error("audio error", filename, ev);
      resolve(); 
    };
    
    a.addEventListener("ended", onEnded);
    a.addEventListener("error", onErr);
    
    a.play().then(() => {
    }).catch(err => {
      onErr(err); 
    });
  });
}

async function playSequence(files, gap = 500, buttonElement = null){
  stopAll(); 
  
  for (const f of files){
    if (stopRequested) break;
    await playAudioElement(f, false, buttonElement);
    if (gap > 0 && !stopRequested){
      await new Promise(r => setTimeout(r, gap));
    }
  }
}

let stopRequested = false;
function stopAll(){
  stopRequested = true;
  if (currentAudio){
    try { currentAudio.pause(); currentAudio.currentTime = 0; } catch(e){}
  }
  isPlaying = false;
  playingButton = null; 
  stopRequested = false; 
}

function disableControlsDuringPlayback(disabled){
  const controls = [ruleBtn, checkBtn, stopBtn, hintBtn, hintBellBtn, startBtn, retryBtn, closeRankingBtn, 
                     ...document.querySelectorAll("#postGameControls button"), 
                     ...document.querySelectorAll("#keypad button")];
  controls.forEach(el=>{
    if (el && el.id !== 'stopBtn' && !el.closest('#keypad')) {
        el.disabled = disabled; 
    }
  });
}

// --- III. ゲームフローヘルパー ---
function pick3Questions(){
  const keys = Object.keys(QUIZ_FILES); 
  let picks;
  do {
    picks = [keys[Math.floor(Math.random()*keys.length)],
             keys[Math.floor(Math.random()*keys.length)],
             keys[Math.floor(Math.random()*keys.length)]];
  } while (picks[0] === picks[1] && picks[1] === picks[2]);
  return picks;
}

function showKeypad(show){
  if(keypad) {
      keypad.setAttribute("aria-hidden", show ? "false" : "true");
  }
  if(keypadWrap) {
    keypadWrap.style.display = show ? "flex" : "none"; 
    if(startBtn) startBtn.setAttribute("aria-expanded", show ? "true" : "false");
  }
}

// ★ ランキング関連の関数 (Firebase Firestore対応) ★

async function getRankingData() {
    // db オブジェクトは index.html で定義されている
    if (typeof db === 'undefined') {
        console.error("Firebase Firestore (db) が初期化されていません。index.html の設定を確認してください。");
        return [];
    }
    
    try {
        // Firestoreの 'ranking' コレクションからデータを取得
        const snapshot = await db.collection(RANKING_COLLECTION_NAME)
            .orderBy('score', 'desc') // スコアが高い順
            .orderBy('time', 'asc')   // タイムが短い順
            .limit(100) // 上位100件
            .get();
        
        const data = [];
        snapshot.forEach(doc => {
            const entry = doc.data();
            data.push({
                score: entry.score,
                time: entry.time,
                name: entry.name,
                timestamp: entry.timestamp 
            });
        });

        return data; 
    } catch (e) {
        console.error("Failed to read ranking data from Firestore", e);
        return [];
    }
}

async function saveScoreToRanking(score, timeTaken) {
    if (typeof db === 'undefined') {
        alert("ランキングの登録に失敗しました。\n\n【原因】\nFirebase Firestore (db) が初期化されていません。index.html の設定を確認してください。");
        return;
    }

    let playerName = prompt("グローバルランキングに登録します。\nお名前（匿名可）を入力してください。", "匿名");
    
    if (playerName === null) {
        return; 
    }
    playerName = playerName.trim() === "" ? "匿名" : playerName.trim();
    
    const newEntry = {
        score: score,
        time: timeTaken, 
        name: playerName,
        // ランキングのソートに使うため、タイムスタンプを保存
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        // Firestoreの 'ranking' コレクションにデータを追加
        await db.collection(RANKING_COLLECTION_NAME).add(newEntry);

        console.log("Score saved successfully to Firebase Firestore.");
    } catch (e) {
        console.error("Failed to write score to Firestore", e);
        alert("ランキングの登録に失敗しました。\n\n【原因の可能性】\n1. index.html の firebaseConfig が間違っている\n2. Firestoreのセキュリティルールが正しく設定されていない（公開済みか）\n\n設定を確認してから再度お試しください。");
    }
}

async function displayRanking(show) {
    if (show) {
        if (retryWrap) retryWrap.style.display = 'none'; 
        if (postGameControls) postGameControls.style.display = 'none'; 
        
        rankingWrap.style.display = 'block';
        rankingList.innerHTML = '<p>ランキングデータを読み込み中...</p>';
        disableControlsDuringPlayback(true); 
        
        const data = await getRankingData(); 
        let html = '';

        if (data.length === 0) {
            rankingList.innerHTML = '<p>ランキングデータの取得に失敗しました。Firebaseの設定（特にルール）を確認してください。</p>';
        } else {
             html = '<table><thead><tr><th>順位</th><th>プレイヤー</th><th>スコア</th><th>タイム</th></tr></thead><tbody>';
             data.forEach((entry, index) => {
                const timeStr = entry.time ? `${entry.time}秒` : 'N/A';
                const playerName = entry.name || '匿名';
                html += `<tr>